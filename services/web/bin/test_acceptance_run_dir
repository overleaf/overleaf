#!/bin/bash

declare -a mocha_prefix=()

if [[ "$COVERAGE_ACCEPTANCE_TESTS" == "true" ]]; then
  name=$(echo "$BASE_CONFIG $OVERLEAF_CONFIG" "$@" | sha256sum)
  dir=data/coverage/mocha-acceptance-${name}
  echo "Enabling coverage. Writing into ${dir}"
  mocha_prefix+=("c8" "--reporter=clover" "--all" "--include={app.mjs,app/**/*.{mjs,js},modules/*/index.mjs,modules/*/app/**/*.{mjs,js}}" "--exclude=app/src/Features/Metadata/packageMapping.mjs" "--report-dir=${dir}")
fi

"${mocha_prefix[@]}" mocha --recursive --timeout 25000 --grep="$MOCHA_GREP" --require test/acceptance/bootstrap.js "$@"
